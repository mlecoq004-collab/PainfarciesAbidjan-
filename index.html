<!DOCTYPE html>
<html lang="fr" class="h-full">
<head>
    <meta charset="UTF-8" />
    <title>Pain Farci DÃ©clice â€“ Abidjan</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover"/>
    <meta name="theme-color" content="#f59e0b">
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: { extend: { colors: { brand: { 500: '#f59e0b', 900: '#451a03' } }, borderRadius: { '5xl': '3rem' } } }
        };
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, doc, updateDoc, increment, onSnapshot, setDoc, serverTimestamp, runTransaction, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = {
          apiKey: "AIzaSyD924DTIFmfD8KQtmdq7OjfZT4jnVS97kc",
          authDomain: "pain-farci-abidjan.firebaseapp.com",
          projectId: "pain-farci-abidjan",
          storageBucket: "pain-farci-abidjan.firebasestorage.app",
          messagingSenderId: "832484741268",
          appId: "1:832484741268:web:18baf4a65a003fa3fca481",
          measurementId: "G-4STB8KX58Y"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        window.fb = { db, auth: getAuth(app), productsCol: collection(db, "products"), ordersCol: collection(db, "orders"), settingsDoc: doc(db, "settings", "store"), onSnapshot, doc, updateDoc, increment, setDoc, serverTimestamp, runTransaction, signOut, signInWithEmailAndPassword, onAuthStateChanged, query, orderBy };
        window.dispatchEvent(new Event('load-app'));
    </script>

    <style>
        .glass { background: rgba(255, 255, 255, 0.75); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        .gradient-brand { background: linear-gradient(135deg, #f59e0b 0%, #ea580c 100%); }
    </style>
</head>
<body class="bg-amber-50/30 text-slate-900 h-full">
    <div id="root">
        <div class="flex items-center justify-center h-screen">
            <div class="text-center animate-pulse">
                <div class="w-10 h-10 border-4 border-brand-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                <p class="text-[10px] font-black uppercase tracking-widest text-slate-400">Connexion en cours...</p>
            </div>
        </div>
    </div>

    <script type="text/babel">
        const { db, auth, productsCol, ordersCol, settingsDoc, onSnapshot, doc, updateDoc, increment, setDoc, serverTimestamp, runTransaction, signOut, signInWithEmailAndPassword, onAuthStateChanged, query, orderBy } = window.fb;
        const SELLER_PHONE = "2250757618108";
        const WAVE_LINK = "https://pay.wave.com/m/M_ci_CmPu37RXsPDN/c/ci/"; 
        const SHOP_LOCATION = "Https://maps.app.goo.gl/kbBVGu5LNdJDQaDY6"; 

        function App() {
            const [products, setProducts] = React.useState([]);
            const [storeStatus, setStoreStatus] = React.useState({ isOpen: true });
            const [cart, setCart] = React.useState([]);
            const [view, setView] = React.useState('home');
            const [lastOrderId, setLastOrderId] = React.useState(localStorage.getItem('lastOrderId'));

            React.useEffect(() => {
                // Charger les produits mÃªme si settings/store n'existe pas
                const unsubP = onSnapshot(productsCol, s => setProducts(s.docs.map(d=>({id:d.id, ...d.data()}))));
                const unsubS = onSnapshot(settingsDoc, d => d.exists() && setStoreStatus(d.data()));
                return () => { unsubP(); unsubS(); };
            }, []);

            const total = cart.reduce((s,i)=>s+(i.price*i.qty),0);

            if (view === 'success') return (
                <div className="h-screen flex flex-col items-center justify-center p-8 text-center bg-white">
                    <div className="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center text-3xl mb-6">âœ…</div>
                    <h2 className="text-2xl font-black mb-6 uppercase italic">C'est envoyÃ© !</h2>
                    <a href={WAVE_LINK} target="_blank" className="w-full bg-[#1dc3ff] text-white p-7 rounded-[2.5rem] font-black shadow-xl flex items-center justify-center gap-2 mb-4">
                        <i className="fas fa-water"></i> PAYER VIA WAVE
                    </a>
                    <button onClick={() => setView('home')} className="mt-8 text-slate-300 font-black text-[10px] uppercase underline">Retour</button>
                </div>
            );

            return (
                <div className="min-h-screen pb-24">
                    <header className="px-6 pt-12 pb-4 sticky top-0 z-40 glass border-b border-amber-50">
                        <div className="flex justify-between items-center">
                            <div>
                                <h1 className="text-3xl font-black text-brand-900 tracking-tighter uppercase italic">DÃ©clice</h1>
                                <p className="text-[10px] font-bold text-brand-500 uppercase tracking-widest leading-none">Pain Farci 225</p>
                            </div>
                            <div className="flex items-center gap-2 bg-amber-100 px-3 py-1 rounded-full">
                                <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                                <span className="text-[8px] font-black uppercase text-amber-700">Service Express</span>
                            </div>
                        </div>
                    </header>

                    <main className="px-6 pt-6 space-y-4 max-w-2xl mx-auto">
                        {products.length === 0 ? (
                            <div className="py-20 text-center text-slate-300 font-black uppercase text-[10px] tracking-[0.4em]">Le menu arrive...</div>
                        ) : (
                            products.map(p => (
                                <div key={p.id} className="bg-white p-5 rounded-[2.5rem] shadow-xl flex items-center gap-4 border border-white active:scale-95 transition-all">
                                    <div className="w-16 h-16 bg-amber-50 rounded-2xl flex items-center justify-center text-3xl">ðŸ¥–</div>
                                    <div className="flex-1">
                                        <h3 className="font-black text-slate-800 uppercase tracking-tighter">{p.name}</h3>
                                        <p className="text-brand-500 font-black text-sm">{p.price.toLocaleString()} F</p>
                                    </div>
                                    <button onClick={() => setCart([...cart, p])} className="bg-brand-500 text-white w-12 h-12 rounded-2xl flex items-center justify-center shadow-lg"><i className="fas fa-plus"></i></button>
                                </div>
                            ))
                        )}
                    </main>

                    {cart.length > 0 && (
                        <div className="fixed bottom-6 left-6 right-6 z-50 max-w-md mx-auto">
                            <button onClick={() => {
                                const name = prompt("Votre Nom ?");
                                const addr = prompt("Quartier ?");
                                if(name && addr) {
                                    const orderId = "CMD-" + Date.now();
                                    setDoc(doc(ordersCol, orderId), {customer: {name, address: addr}, items: cart, total, status: "ReÃ§ue", createdAt: serverTimestamp()});
                                    window.open(`https://wa.me/${SELLER_PHONE}?text=${encodeURIComponent("ðŸ¥– COMMANDE: " + name + "\nTotal: " + total + "F")}`);
                                    setCart([]); setView('success');
                                }
                            }} className="w-full bg-slate-900 text-white p-6 rounded-[2rem] flex justify-between items-center shadow-2xl border-4 border-white font-black uppercase italic text-xs">
                                <span>Commander ({cart.length})</span><span>{total.toLocaleString()} F</span>
                            </button>
                        </div>
                    )}
                </div>
            );
        }

        window.addEventListener('load-app', () => {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
        });
    </script>
</body>
</html>
