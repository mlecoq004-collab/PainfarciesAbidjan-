<!DOCTYPE html>
<html lang="fr" class="h-full">
<head>
    <meta charset="UTF-8" />
    <title>Pain Farci DÃ©clice â€“ Abidjan</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover"/>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #fafafa; }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
        .gradient-btn { background: linear-gradient(135deg, #f59e0b 0%, #ea580c 100%); }
        .animate-pop { animation: pop 0.3s ease-out; }
        @keyframes pop { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="h-full">
    <div id="root">
        <div class="flex flex-col items-center justify-center h-screen">
            <div class="w-10 h-10 border-4 border-orange-500 border-t-transparent rounded-full animate-spin mb-4"></div>
            <p class="text-[10px] font-black uppercase tracking-widest text-gray-400">DÃ©marrage DÃ©clice...</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, doc, updateDoc, increment, onSnapshot, setDoc, serverTimestamp, runTransaction, query, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = {
          apiKey: "AIzaSyD924DTIFmfD8KQtmdq7OjfZT4jnVS97kc",
          authDomain: "pain-farci-abidjan.firebaseapp.com",
          projectId: "pain-farci-abidjan",
          storageBucket: "pain-farci-abidjan.firebasestorage.app",
          messagingSenderId: "832484741268",
          appId: "1:832484741268:web:18baf4a65a003fa3fca481",
          measurementId: "G-4STB8KX58Y"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            
            window.fb = { 
                app, db, auth, 
                productsCol: collection(db, "products"), 
                ordersCol: collection(db, "orders"), 
                settingsDoc: doc(db, "settings", "store"), 
                onSnapshot, doc, updateDoc, increment, setDoc, 
                serverTimestamp, runTransaction, signOut, 
                signInWithEmailAndPassword, onAuthStateChanged, 
                query, orderBy, getDoc, collection 
            };
            console.log('Firebase initialisÃ©');
            window.dispatchEvent(new Event('fb-ready'));
        } catch (err) {
            console.error('Erreur Firebase:', err);
            document.getElementById('root').innerHTML = `
                <div class="p-10 text-red-500 font-bold text-center">
                    Erreur de connexion. VÃ©rifiez votre internet.<br>
                    <small>${err.message}</small>
                </div>`;
        }
    </script>

    <script type="text/babel">
        const SELLER_PHONE = "2250757618108";
        const WAVE_LINK = "https://pay.wave.com/m/M_ci_CmPu37RXsPDN/c/ci/";
        const SHOP_MAPS = "https://maps.app.goo.gl/kbBVGu5LNdJDQaDY6";

        // Fonction pour Ã©chapper les entrÃ©es
        const escapeInput = (str) => {
            if (!str) return '';
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#x27;');
        };

        function MainApp() {
            const [products, setProducts] = React.useState([]);
            const [store, setStore] = React.useState({ isOpen: true });
            const [cart, setCart] = React.useState({}); // ChangÃ© pour un objet {productId: quantity}
            const [user, setUser] = React.useState(null);
            const [orderId, setOrderId] = React.useState(localStorage.getItem('lastOrderId'));
            const [view, setView] = React.useState('home');
            const [loading, setLoading] = React.useState(true);

            React.useEffect(() => {
                if (!window.fb) {
                    console.error('Firebase non initialisÃ©');
                    return;
                }

                const { auth, settingsDoc, productsCol, onSnapshot, onAuthStateChanged, query, orderBy } = window.fb;
                
                // Ã‰couter l'Ã©tat d'authentification
                const unsubscribeAuth = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                });

                // Ã‰couter les paramÃ¨tres du magasin
                const unsubscribeStore = onSnapshot(settingsDoc, (doc) => {
                    if (doc.exists()) {
                        setStore(doc.data());
                    }
                });

                // Ã‰couter les produits
                const unsubscribeProducts = onSnapshot(
                    query(productsCol, orderBy("name")), 
                    (snapshot) => {
                        const prods = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                        setProducts(prods);
                        setLoading(false);
                    },
                    (error) => {
                        console.error('Erreur produits:', error);
                        setLoading(false);
                    }
                );

                return () => {
                    unsubscribeAuth();
                    unsubscribeStore();
                    unsubscribeProducts();
                };
            }, []);

            // Calculer le total
            const total = React.useMemo(() => {
                return Object.entries(cart).reduce((acc, [productId, quantity]) => {
                    const product = products.find(p => p.id === productId);
                    return acc + (product ? product.price * quantity : 0);
                }, 0);
            }, [cart, products]);

            // Ajouter au panier
            const addToCart = (product) => {
                if (!store.isOpen || product.stock <= 0) return;
                
                setCart(prev => ({
                    ...prev,
                    [product.id]: (prev[product.id] || 0) + 1
                }));
            };

            // Retirer du panier
            const removeFromCart = (productId) => {
                setCart(prev => {
                    const newCart = { ...prev };
                    if (newCart[productId] > 1) {
                        newCart[productId]--;
                    } else {
                        delete newCart[productId];
                    }
                    return newCart;
                });
            };

            // Convertir le panier en array pour la commande
            const cartArray = React.useMemo(() => {
                return Object.entries(cart).map(([productId, quantity]) => {
                    const product = products.find(p => p.id === productId);
                    return product ? {
                        ...product,
                        quantity,
                        price: product.price * quantity
                    } : null;
                }).filter(Boolean);
            }, [cart, products]);

            const handleOrder = async () => {
                if (cartArray.length === 0) return;
                
                const name = prompt("Votre Nom complet ?");
                const addr = prompt("Votre Quartier prÃ©cis ?");
                
                if (!name || !addr) {
                    alert("Les informations sont obligatoires !");
                    return;
                }

                // Nettoyer les entrÃ©es
                const cleanName = escapeInput(name.trim());
                const cleanAddr = escapeInput(addr.trim());

                const newId = "CMD-" + Date.now();
                
                try {
                    const { db, runTransaction, doc, ordersCol, serverTimestamp } = window.fb;
                    
                    await runTransaction(db, async (transaction) => {
                        // VÃ©rifier et mettre Ã  jour les stocks
                        for (const item of cartArray) {
                            const productRef = doc(db, "products", item.id);
                            const productSnap = await transaction.get(productRef);
                            
                            if (!productSnap.exists()) {
                                throw new Error(`Produit ${item.name} non trouvÃ©`);
                            }
                            
                            const currentStock = productSnap.data().stock;
                            if (currentStock < item.quantity) {
                                throw new Error(`Stock insuffisant pour ${item.name}. Disponible: ${currentStock}`);
                            }
                            
                            // Mettre Ã  jour le stock
                            transaction.update(productRef, {
                                stock: currentStock - item.quantity
                            });
                        }

                        // CrÃ©er la commande
                        transaction.set(doc(ordersCol, newId), {
                            customer: {
                                name: cleanName,
                                address: cleanAddr
                            },
                            items: cartArray.map(item => ({
                                id: item.id,
                                name: item.name,
                                price: item.price,
                                quantity: item.quantity
                            })),
                            total: total,
                            status: "ReÃ§ue",
                            createdAt: serverTimestamp()
                        });
                    });

                    // Ouvrir WhatsApp
                    const whatsappMessage = encodeURIComponent(
                        `ðŸ¥– NOUVELLE COMMANDE ${newId}\n` +
                        `Nom: ${cleanName}\n` +
                        `Quartier: ${cleanAddr}\n` +
                        `Total: ${total}F\n` +
                        `Items: ${cartArray.map(item => `${item.quantity}x ${item.name}`).join(', ')}`
                    );
                    
                    window.open(`https://wa.me/${SELLER_PHONE}?text=${whatsappMessage}`, '_blank');
                    
                    // RÃ©initialiser
                    localStorage.setItem('lastOrderId', newId);
                    setOrderId(newId);
                    setCart({});
                    setView('success');
                    
                } catch (error) {
                    console.error('Erreur commande:', error);
                    alert(`Erreur: ${error.message || "Impossible de passer la commande"}`);
                }
            };

            // Gestion admin
            if (window.location.hash === "#admin") {
                if (user) {
                    return <AdminUI fb={window.fb} store={store} signout={() => window.fb.auth.signOut()} />;
                }
                return <LoginUI auth={window.fb.auth} signin={signInWithEmailAndPassword} />;
            }

            // Vue succÃ¨s
            if (view === 'success') {
                return (
                    <div className="flex flex-col items-center justify-center h-screen p-6 text-center animate-pop">
                        <div className="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center text-3xl mb-6">
                            <i className="fas fa-check"></i>
                        </div>
                        <h2 className="text-2xl font-black mb-6 uppercase italic tracking-tighter">Commande confirmÃ©e !</h2>
                        <p className="text-gray-600 mb-8 text-sm">
                            NÂ°: <span className="font-bold">{orderId}</span><br/>
                            Total: <span className="font-bold">{total}F</span>
                        </p>
                        <a href={WAVE_LINK} target="_blank" rel="noopener noreferrer" 
                           className="w-full bg-[#1dc3ff] text-white p-6 rounded-[2rem] font-black shadow-xl mb-4 hover:opacity-90 transition-opacity">
                            <i className="fas fa-money-bill-wave mr-2"></i> PAYER VIA WAVE
                        </a>
                        <p className="text-[10px] font-bold text-gray-400 uppercase tracking-widest italic mb-8 px-4">
                            Payez et envoyez la capture sur WhatsApp. On prÃ©pare dÃ©jÃ  !
                        </p>
                        <button onClick={() => setView('home')} 
                                className="text-orange-500 font-black text-[10px] uppercase underline hover:text-orange-600">
                            Retour au menu
                        </button>
                    </div>
                );
            }

            return (
                <div className="min-h-screen pb-24">
                    <header className="p-6 sticky top-0 z-50 glass border-b border-gray-100 flex justify-between items-center">
                        <div>
                            <h1 className="text-2xl font-black text-gray-900 tracking-tighter uppercase italic leading-none">DÃ©clice</h1>
                            <p className="text-[8px] font-black text-orange-500 uppercase tracking-[0.3em]">Abidjan Express</p>
                        </div>
                        <div className={`px-3 py-1 rounded-full text-[8px] font-black uppercase ${store.isOpen ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                            {store.isOpen ? "ðŸŸ¢ Ouvert" : "ðŸ”´ FermÃ©"}
                        </div>
                    </header>

                    {orderId && <OrderTracker fb={window.fb} orderId={orderId} />}

                    <main className="p-6 space-y-4 max-w-xl mx-auto">
                        {loading ? (
                            <div className="py-20 text-center text-gray-300 font-black uppercase text-[10px] tracking-widest animate-pulse">
                                Chargement des produits...
                            </div>
                        ) : products.length === 0 ? (
                            <div className="py-20 text-center text-gray-400 font-bold">
                                Aucun produit disponible
                            </div>
                        ) : products.map(product => {
                            const cartQuantity = cart[product.id] || 0;
                            const isDisabled = !store.isOpen || product.stock <= 0;
                            
                            return (
                                <div key={product.id} 
                                     className={`bg-white p-4 rounded-[2rem] shadow-xl flex items-center gap-4 border transition-all ${isDisabled ? 'opacity-50 grayscale' : 'hover:shadow-lg'}`}>
                                    <div className="w-14 h-14 bg-orange-50 rounded-2xl flex items-center justify-center text-2xl">
                                        {product.emoji || 'ðŸ¥–'}
                                    </div>
                                    <div className="flex-1">
                                        <h3 className="font-black text-gray-800 text-sm uppercase leading-none mb-1">
                                            {product.name}
                                        </h3>
                                        <p className="text-orange-600 font-black text-xs">{product.price} F</p>
                                        <p className="text-gray-400 text-[9px] font-bold mt-1">
                                            Stock: {product.stock}
                                            {cartQuantity > 0 && ` â€¢ Panier: ${cartQuantity}`}
                                        </p>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        {cartQuantity > 0 && (
                                            <button onClick={() => removeFromCart(product.id)}
                                                    className="w-8 h-8 bg-gray-100 text-gray-700 rounded-lg flex items-center justify-center font-bold">
                                                <i className="fas fa-minus text-[10px]"></i>
                                            </button>
                                        )}
                                        <button disabled={isDisabled}
                                                onClick={() => addToCart(product)}
                                                className={`w-10 h-10 rounded-xl flex items-center justify-center shadow-lg transition-all ${isDisabled ? 'bg-gray-200 text-gray-400' : 'bg-orange-500 text-white hover:bg-orange-600 active:scale-95'}`}>
                                            <i className="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            );
                        })}
                    </main>

                    {cartArray.length > 0 && (
                        <div className="fixed bottom-6 left-6 right-6 z-50 max-w-md mx-auto">
                            <div className="bg-white rounded-[2rem] shadow-2xl border-2 border-white mb-3 p-4">
                                <div className="flex justify-between items-center mb-2">
                                    <span className="font-black text-xs text-gray-700">Total articles:</span>
                                    <span className="font-black text-xs">{cartArray.reduce((acc, item) => acc + item.quantity, 0)}</span>
                                </div>
                                <div className="flex justify-between items-center">
                                    <span className="font-black text-xs text-gray-700">Montant total:</span>
                                    <span className="font-black text-lg">{total} F</span>
                                </div>
                            </div>
                            <button onClick={handleOrder}
                                    disabled={!store.isOpen}
                                    className={`w-full p-5 rounded-[2rem] flex justify-between items-center font-black uppercase italic text-xs tracking-widest transition-all ${!store.isOpen ? 'bg-gray-400 cursor-not-allowed' : 'bg-gray-900 text-white hover:bg-black'}`}>
                                <span>Commander ({cartArray.length})</span>
                                <span>{total} F</span>
                            </button>
                        </div>
                    )}
                </div>
            );
        }

        const OrderTracker = ({fb, orderId}) => {
            const [order, setOrder] = React.useState(null);
            const [loading, setLoading] = React.useState(true);

            React.useEffect(() => {
                if (!orderId || !fb) return;
             
